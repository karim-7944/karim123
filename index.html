<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JEE Quiz Engine</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #141418;
    --surface2: #1c1c22;
    --border: #2a2a35;
    --accent: #e8c547;
    --accent2: #4ade80;
    --danger: #f87171;
    --warning: #fb923c;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --correct: #166534;
    --correct-border: #4ade80;
    --wrong: #7f1d1d;
    --wrong-border: #f87171;
    --marked: #1e3a5f;
    --marked-border: #60a5fa;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'IBM Plex Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== SCREENS ===== */
  .screen { display: none; min-height: 100vh; }
  .screen.active { display: flex; flex-direction: column; }

  /* ===== HOME SCREEN ===== */
  #home {
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background: radial-gradient(ellipse at 50% 0%, #1a1a2e 0%, var(--bg) 70%);
  }

  .home-inner {
    width: 100%;
    max-width: 680px;
  }

  .logo-area {
    text-align: center;
    margin-bottom: 3rem;
  }

  .logo-tag {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  h1 {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 600;
    letter-spacing: -0.02em;
    line-height: 1.1;
    color: var(--text);
  }

  .subtitle {
    color: var(--muted);
    margin-top: 0.5rem;
    font-size: 0.95rem;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }

  .card-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  label {
    display: block;
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 0.4rem;
  }

  input[type="text"], input[type="number"], select, textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.6rem 0.9rem;
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--accent);
  }

  textarea { resize: vertical; font-family: 'IBM Plex Mono', monospace; font-size: 0.78rem; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.65rem 1.4rem;
    border-radius: 8px;
    border: none;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--accent);
    color: #0d0d0f;
  }
  .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

  .btn-danger {
    background: var(--danger);
    color: #0d0d0f;
  }

  .btn-full { width: 100%; justify-content: center; }

  .row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
  .col { flex: 1; min-width: 140px; }

  /* Question bank list */
  .bank-list { list-style: none; }
  .bank-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    background: var(--surface2);
    margin-bottom: 0.4rem;
    font-size: 0.85rem;
  }
  .bank-item .remove-btn {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
  }
  .bank-badge {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    background: var(--border);
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 0.5rem;
  }

  /* ===== QUIZ SCREEN ===== */
  #quiz { flex-direction: row; overflow: hidden; height: 100vh; }

  /* Left panel */
  .quiz-left {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .quiz-header {
    padding: 0.75rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .quiz-title {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .quiz-timer {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--accent);
    letter-spacing: 0.05em;
  }

  .quiz-timer.warning { color: var(--warning); animation: pulse 1s infinite; }
  .quiz-timer.danger { color: var(--danger); animation: pulse 0.5s infinite; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Section tabs */
  .section-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    overflow-x: auto;
    padding: 0 1rem;
  }

  .section-tab {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    color: var(--muted);
    transition: all 0.2s;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    font-family: 'IBM Plex Sans', sans-serif;
    color: var(--muted);
  }

  .section-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  /* Question area */
  .question-area {
    flex: 1;
    overflow-y: auto;
    padding: 2rem 1.5rem;
  }

  .question-meta {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    margin-bottom: 1rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .q-tag {
    padding: 2px 8px;
    border-radius: 4px;
    border: 1px solid var(--border);
  }

  .q-tag.positive { border-color: var(--correct-border); color: var(--correct-border); }
  .q-tag.negative { border-color: var(--wrong-border); color: var(--wrong-border); }

  .question-text {
    font-size: 1rem;
    line-height: 1.7;
    color: var(--text);
    margin-bottom: 1.75rem;
    font-weight: 400;
  }

  .question-number {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }

  /* MCQ Options */
  .options-list { list-style: none; display: flex; flex-direction: column; gap: 0.65rem; }

  .option-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.85rem 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }

  .option-item:hover { border-color: var(--accent); background: rgba(232,197,71,0.04); }
  .option-item.selected { border-color: var(--accent); background: rgba(232,197,71,0.08); }

  .option-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--accent);
    min-width: 1.5rem;
    margin-top: 1px;
  }

  .option-text { font-size: 0.92rem; line-height: 1.5; }

  /* Integer type */
  .integer-input-wrap { margin-top: 1rem; }
  .integer-input {
    width: 200px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.2rem;
    text-align: center;
    padding: 0.75rem;
  }

  /* Question nav bottom */
  .question-nav-bar {
    padding: 0.75rem 1.5rem;
    border-top: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    gap: 0.6rem;
    justify-content: space-between;
    align-items: center;
  }

  .nav-btns { display: flex; gap: 0.5rem; }

  .btn-mark {
    background: var(--surface2);
    color: #60a5fa;
    border: 1px solid #60a5fa44;
  }
  .btn-mark:hover, .btn-mark.active-mark {
    background: rgba(96,165,250,0.15);
    border-color: #60a5fa;
  }

  .btn-clear {
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
  }
  .btn-clear:hover { border-color: var(--danger); color: var(--danger); }

  /* Right panel - question palette */
  .quiz-right {
    width: 260px;
    border-left: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .palette-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--muted);
  }

  .palette-legend {
    padding: 0.75rem 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    border-bottom: 1px solid var(--border);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.7rem;
    color: var(--muted);
  }

  .legend-dot {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .legend-dot.not-visited { background: var(--surface2); border: 1px solid var(--border); }
  .legend-dot.answered { background: var(--accent2); }
  .legend-dot.not-answered { background: var(--danger); }
  .legend-dot.marked { background: #60a5fa; }
  .legend-dot.marked-answered { background: var(--accent); }

  .palette-grid {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-content: flex-start;
  }

  .palette-btn {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--muted);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .palette-btn.answered { background: var(--accent2); border-color: var(--correct-border); color: #0d0d0f; }
  .palette-btn.not-answered { background: var(--danger); border-color: var(--wrong-border); color: #0d0d0f; }
  .palette-btn.marked { background: #60a5fa; border-color: #60a5fa; color: #0d0d0f; }
  .palette-btn.marked-answered { background: var(--accent); border-color: var(--accent); color: #0d0d0f; }
  .palette-btn.current { box-shadow: 0 0 0 2px #fff4, 0 0 0 3px var(--text); }

  .palette-stats {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.78rem;
    color: var(--muted);
  }

  .stat-row span:last-child { color: var(--text); font-weight: 500; }

  .submit-btn-wrap { padding: 0.75rem 1rem; }

  /* ===== RESULT SCREEN ===== */
  #result {
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background: radial-gradient(ellipse at 50% 0%, #1a1a2e 0%, var(--bg) 70%);
  }

  .result-inner {
    width: 100%;
    max-width: 700px;
  }

  .result-header { text-align: center; margin-bottom: 2rem; }

  .result-score {
    font-size: clamp(3rem, 8vw, 5rem);
    font-weight: 600;
    font-family: 'IBM Plex Mono', monospace;
    color: var(--accent);
    line-height: 1;
  }

  .result-out-of {
    font-size: 1rem;
    color: var(--muted);
    margin-top: 0.25rem;
  }

  .result-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .result-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
  }

  .result-card-val {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.6rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .result-card-label {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .color-correct { color: var(--accent2); }
  .color-wrong { color: var(--danger); }
  .color-skip { color: var(--muted); }

  /* Review table */
  .review-wrap { max-height: 400px; overflow-y: auto; }
  .review-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  .review-table th {
    text-align: left;
    padding: 0.5rem 0.75rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--surface);
  }

  .review-table td {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid #1c1c22;
    vertical-align: top;
  }

  .review-table tr.r-correct td { background: rgba(74,222,128,0.05); }
  .review-table tr.r-wrong td { background: rgba(248,113,113,0.05); }

  /* Anti-cheat overlay */
  #cheat-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.95);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    padding: 2rem;
  }

  #cheat-overlay.show { display: flex; }

  .cheat-icon { font-size: 3rem; margin-bottom: 1rem; }

  .cheat-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--danger);
    margin-bottom: 0.5rem;
  }

  .cheat-msg { color: var(--muted); margin-bottom: 1.5rem; max-width: 400px; }
  .cheat-count { font-family: 'IBM Plex Mono', monospace; color: var(--warning); font-size: 0.85rem; }

  /* Import modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 999;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    width: 100%;
    max-width: 650px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .modal-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-body { flex: 1; overflow-y: auto; padding: 1.25rem; }
  .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end; }

  .close-btn { background: none; border: none; color: var(--muted); font-size: 1.2rem; cursor: pointer; }
  .close-btn:hover { color: var(--text); }

  pre.template-pre {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.73rem;
    color: var(--muted);
    overflow-x: auto;
    white-space: pre-wrap;
    margin-bottom: 1rem;
  }

  .error-msg { color: var(--danger); font-size: 0.82rem; margin-top: 0.5rem; }
  .success-msg { color: var(--accent2); font-size: 0.82rem; margin-top: 0.5rem; }

  .scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
  .scrollbar::-webkit-scrollbar-track { background: transparent; }
  .scrollbar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* Responsive */
  @media (max-width: 640px) {
    #quiz { flex-direction: column; }
    .quiz-right { width: 100%; height: 180px; border-left: none; border-top: 1px solid var(--border); }
    .palette-grid { flex-direction: row; }
    .result-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<!-- ===== HOME SCREEN ===== -->
<div class="screen active" id="home">
  <div class="home-inner">
    <div class="logo-area">
      <div class="logo-tag">JEE Quiz Engine</div>
      <h1>Practice.<br>Analyze. Improve.</h1>
      <p class="subtitle">JEE Mains format ¬∑ Anti-cheat ¬∑ Custom chapters</p>
    </div>

    <!-- Loaded Banks -->
    <div class="card" id="banks-card">
      <div class="card-title">Question Banks Loaded</div>
      <ul class="bank-list" id="bank-list">
        <li style="font-size:0.82rem; color:var(--muted); padding:0.5rem 0;">No chapters loaded. Import one below.</li>
      </ul>
      <div class="row" style="margin-top:0.75rem;">
        <button class="btn btn-secondary" onclick="openImport()">Ôºã Import Chapter (JSON)</button>
        <button class="btn btn-secondary" onclick="openTemplate()">View Template</button>
      </div>
    </div>

    <!-- Config -->
    <div class="card">
      <div class="card-title">Quiz Settings</div>
      <div class="row">
        <div class="col form-group">
          <label>Questions Per Section</label>
          <input type="number" id="q-per-section" value="30" min="1">
        </div>
        <div class="col form-group">
          <label>Time (minutes)</label>
          <input type="number" id="time-limit" value="180" min="1">
        </div>
      </div>
      <div class="row">
        <div class="col form-group">
          <label>Marking: Correct</label>
          <input type="number" id="mark-correct" value="4" step="0.5">
        </div>
        <div class="col form-group">
          <label>Marking: Wrong</label>
          <input type="number" id="mark-wrong" value="-1" step="0.5">
        </div>
      </div>
      <div class="form-group">
        <label>Anti-cheat ‚Äî Tab switch warnings before auto-submit</label>
        <input type="number" id="max-violations" value="3" min="1" max="10">
      </div>
    </div>

    <button class="btn btn-primary btn-full" onclick="startQuiz()" style="font-size:1rem; padding:0.85rem;">
      Start Quiz ‚Üí
    </button>
  </div>
</div>

<!-- ===== QUIZ SCREEN ===== -->
<div class="screen" id="quiz">
  <!-- Left -->
  <div class="quiz-left">
    <div class="quiz-header">
      <span class="quiz-title" id="quiz-title-text">Quiz</span>
      <span class="quiz-timer" id="timer">03:00:00</span>
    </div>
    <div class="section-tabs scrollbar" id="section-tabs"></div>
    <div class="question-area scrollbar" id="question-area"></div>
    <div class="question-nav-bar">
      <div class="nav-btns">
        <button class="btn btn-secondary" onclick="prevQuestion()">‚Üê Prev</button>
        <button class="btn btn-secondary" onclick="nextQuestion()">Next ‚Üí</button>
      </div>
      <div class="nav-btns">
        <button class="btn btn-mark" id="mark-btn" onclick="toggleMark()">üîñ Mark for Review</button>
        <button class="btn btn-clear" onclick="clearResponse()">Clear</button>
      </div>
    </div>
  </div>

  <!-- Right palette -->
  <div class="quiz-right scrollbar">
    <div class="palette-header">Question Palette</div>
    <div class="palette-legend">
      <div class="legend-item"><div class="legend-dot not-visited"></div>Not Visited</div>
      <div class="legend-item"><div class="legend-dot answered"></div>Answered</div>
      <div class="legend-item"><div class="legend-dot not-answered"></div>Not Answered</div>
      <div class="legend-item"><div class="legend-dot marked"></div>Marked</div>
      <div class="legend-item"><div class="legend-dot marked-answered"></div>Mark+Ans</div>
    </div>
    <div class="palette-grid scrollbar" id="palette-grid"></div>
    <div class="palette-stats">
      <div class="stat-row"><span>Answered</span><span id="stat-answered">0</span></div>
      <div class="stat-row"><span>Not Answered</span><span id="stat-not-answered">0</span></div>
      <div class="stat-row"><span>Marked</span><span id="stat-marked">0</span></div>
      <div class="stat-row"><span>Not Visited</span><span id="stat-not-visited">0</span></div>
    </div>
    <div class="submit-btn-wrap">
      <button class="btn btn-primary btn-full" onclick="confirmSubmit()">Submit Test</button>
    </div>
  </div>
</div>

<!-- ===== RESULT SCREEN ===== -->
<div class="screen" id="result">
  <div class="result-inner">
    <div class="result-header">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:0.7rem;color:var(--muted);letter-spacing:0.2em;margin-bottom:0.5rem;">SCORE</div>
      <div class="result-score" id="res-score">0</div>
      <div class="result-out-of" id="res-out-of">out of 0</div>
    </div>
    <div class="result-grid" id="result-grid"></div>
    <div class="card">
      <div class="card-title" style="margin-bottom:0.75rem;">Answer Review</div>
      <div class="review-wrap scrollbar">
        <table class="review-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Section</th>
              <th>Question</th>
              <th>Your Answer</th>
              <th>Correct</th>
              <th>Marks</th>
            </tr>
          </thead>
          <tbody id="review-body"></tbody>
        </table>
      </div>
    </div>
    <div style="margin-top:1rem;display:flex;gap:0.75rem;">
      <button class="btn btn-primary" onclick="showHome()">‚Üê Back to Home</button>
    </div>
  </div>
</div>

<!-- Anti-cheat overlay -->
<div id="cheat-overlay">
  <div class="cheat-icon">‚ö†Ô∏è</div>
  <div class="cheat-title">Tab Switch Detected!</div>
  <p class="cheat-msg" id="cheat-msg">You have left the exam window. This is recorded.</p>
  <div class="cheat-count" id="cheat-count"></div>
  <button class="btn btn-danger" style="margin-top:1.5rem;" onclick="dismissCheatWarning()">Return to Exam</button>
</div>

<!-- Import Modal -->
<div class="modal-overlay" id="import-modal">
  <div class="modal">
    <div class="modal-header">
      <strong>Import Chapter (JSON)</strong>
      <button class="close-btn" onclick="closeImport()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Paste JSON or use file upload</label>
        <textarea id="import-json" rows="12" placeholder='{"name":"Physics - Kinematics","questions":[...]}'></textarea>
        <div id="import-msg"></div>
      </div>
      <div>
        <input type="file" id="json-file" accept=".json" style="display:none" onchange="loadJSONFile(event)">
        <button class="btn btn-secondary" onclick="document.getElementById('json-file').click()">üìÇ Load from File</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeImport()">Cancel</button>
      <button class="btn btn-primary" onclick="importChapter()">Import</button>
    </div>
  </div>
</div>

<!-- Template Modal -->
<div class="modal-overlay" id="template-modal">
  <div class="modal">
    <div class="modal-header">
      <strong>Chapter JSON Template</strong>
      <button class="close-btn" onclick="document.getElementById('template-modal').classList.remove('show')">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.85rem;color:var(--muted);margin-bottom:1rem;">Create a <code>.json</code> file with this structure. Each chapter is one file. The <code>type</code> field supports <code>"mcq"</code> (single correct) and <code>"integer"</code> (numerical answer).</p>
      <pre class="template-pre" id="template-pre"></pre>
      <button class="btn btn-secondary" onclick="copyTemplate()">üìã Copy Template</button>
    </div>
  </div>
</div>

<script>
// ===================================================
// DATA STORE
// ===================================================
let banks = []; // [{name, questions:[{id,text,type,options,correct,chapter}]}]
let quizSections = []; // sections derived from banks
let state = {
  currentSection: 0,
  currentQ: 0,
  responses: [],     // parallel to flat questions array
  status: [],        // 'not_visited','not_answered','answered','marked','marked_answered'
  marked: [],
  visited: [],
  timerInterval: null,
  timeLeft: 0,
  violations: 0,
  maxViolations: 3,
  running: false,
  quizFlat: []       // flat questions
};

const TEMPLATE = {
  name: "Physics - Kinematics",
  questions: [
    {
      id: "k001",
      type: "mcq",
      text: "A particle starts from rest and accelerates uniformly at 2 m/s¬≤. What is its velocity after 5 seconds?",
      options: ["5 m/s", "10 m/s", "15 m/s", "20 m/s"],
      correct: 1
    },
    {
      id: "k002",
      type: "mcq",
      text: "Which of the following is a vector quantity?",
      options: ["Speed", "Distance", "Displacement", "Mass"],
      correct: 2
    },
    {
      id: "k003",
      type: "integer",
      text: "A ball is thrown vertically upward with an initial velocity of 20 m/s. Find the maximum height reached (in metres). [g = 10 m/s¬≤]",
      correct: 20
    }
  ]
};

// ===================================================
// HOME
// ===================================================
function renderBankList() {
  const list = document.getElementById('bank-list');
  if (banks.length === 0) {
    list.innerHTML = '<li style="font-size:0.82rem;color:var(--muted);padding:0.5rem 0;">No chapters loaded. Import one below.</li>';
    return;
  }
  list.innerHTML = banks.map((b, i) => `
    <li class="bank-item">
      <span>${b.name}<span class="bank-badge">${b.questions.length} Qs</span></span>
      <button class="remove-btn" onclick="removeBank(${i})">‚úï</button>
    </li>`).join('');
}

function removeBank(i) { banks.splice(i, 1); renderBankList(); }

function openImport() { document.getElementById('import-modal').classList.add('show'); }
function closeImport() { document.getElementById('import-modal').classList.remove('show'); document.getElementById('import-msg').textContent=''; }

function loadJSONFile(e) {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => { document.getElementById('import-json').value = ev.target.result; };
  r.readAsText(f);
}

function importChapter() {
  const txt = document.getElementById('import-json').value.trim();
  const msgEl = document.getElementById('import-msg');
  try {
    const data = JSON.parse(txt);
    if (!data.name || !Array.isArray(data.questions)) throw new Error('Missing "name" or "questions" array.');
    data.questions.forEach((q,i) => {
      if (!q.text) throw new Error(`Question ${i+1}: missing "text".`);
      if (!q.type || !['mcq','integer'].includes(q.type)) throw new Error(`Question ${i+1}: type must be "mcq" or "integer".`);
      if (q.type === 'mcq' && (!Array.isArray(q.options) || q.options.length < 2)) throw new Error(`Question ${i+1}: MCQ needs at least 2 options.`);
      if (q.correct === undefined) throw new Error(`Question ${i+1}: missing "correct".`);
      q._bank = data.name;
    });
    banks.push({ name: data.name, questions: data.questions });
    renderBankList();
    msgEl.className = 'success-msg';
    msgEl.textContent = `‚úì Imported "${data.name}" with ${data.questions.length} questions.`;
    document.getElementById('import-json').value = '';
    setTimeout(closeImport, 1200);
  } catch (err) {
    msgEl.className = 'error-msg';
    msgEl.textContent = '‚úó ' + err.message;
  }
}

function openTemplate() {
 document.getElementById('template-pre').textContent = JSON.stringify(TEMPLATE, null, 2);

// ==============================
// AUTO LOAD DEFAULT QUESTIONS
// ==============================

function importChapterFromData(data) {
  if (!data.name || !Array.isArray(data.questions)) return;

  data.questions.forEach((q,i) => {
    if (!q.text) return;
    if (!q.type || !['mcq','integer'].includes(q.type)) return;
    if (q.type === 'mcq' && (!Array.isArray(q.options) || q.options.length < 2)) return;
    if (q.correct === undefined) return;
    q._bank = data.name;
  });

  banks.push({ name: data.name, questions: data.questions });
  renderBankList();
}

fetch("questions.json")
  .then(res => res.json())
  .then(data => {
    importChapterFromData(data);
  })
  .catch(() => console.log("No default questions found"));
  document.getElementById('template-modal').classList.add('show');
}

function copyTemplate() {
  navigator.clipboard.writeText(JSON.stringify(TEMPLATE, null, 2));
}

// ===================================================
// START QUIZ
// ===================================================
function startQuiz() {
  if (banks.length === 0) { alert('Please import at least one chapter.'); return; }

  const qPerSection = parseInt(document.getElementById('q-per-section').value) || 30;
  const timeMins = parseInt(document.getElementById('time-limit').value) || 180;
  state.maxViolations = parseInt(document.getElementById('max-violations').value) || 3;

  const markCorrect = parseFloat(document.getElementById('mark-correct').value) || 4;
  const markWrong = parseFloat(document.getElementById('mark-wrong').value) || -1;

  // Build sections from banks ‚Äî shuffle each bank's questions, pick up to qPerSection
  quizSections = banks.map(b => {
    const shuffled = [...b.questions].sort(() => Math.random() - 0.5);
    return {
      name: b.name,
      questions: shuffled.slice(0, qPerSection),
      markCorrect,
      markWrong
    };
  });

  // Flatten
  state.quizFlat = [];
  quizSections.forEach((s, si) => {
    s.questions.forEach((q, qi) => {
      state.quizFlat.push({ ...q, _sectionIndex: si, _sectionName: s.name, _localIndex: qi });
    });
  });

  const total = state.quizFlat.length;
  state.responses = new Array(total).fill(null);
  state.status = new Array(total).fill('not_visited');
  state.violations = 0;
  state.timeLeft = timeMins * 60;
  state.currentSection = 0;
  state.currentQ = 0;
  state.running = true;

  showScreen('quiz');
  renderSectionTabs();
  renderPalette();
  goToQuestion(0);
  startTimer();
  attachAntiCheat();
}

// ===================================================
// QUIZ RENDERING
// ===================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function renderSectionTabs() {
  const tabs = document.getElementById('section-tabs');
  tabs.innerHTML = quizSections.map((s, i) => `
    <button class="section-tab ${i === state.currentSection ? 'active' : ''}" onclick="goToSection(${i})">${s.name}</button>
  `).join('');
}

function goToSection(si) {
  state.currentSection = si;
  renderSectionTabs();
  // Find first question of section
  const idx = state.quizFlat.findIndex(q => q._sectionIndex === si);
  if (idx >= 0) goToQuestion(idx);
}

function goToQuestion(idx) {
  if (idx < 0 || idx >= state.quizFlat.length) return;
  state.currentQ = idx;

  // Update section tab
  state.currentSection = state.quizFlat[idx]._sectionIndex;
  renderSectionTabs();

  // Mark visited
  if (state.status[idx] === 'not_visited') state.status[idx] = 'not_answered';

  renderQuestionArea();
  updateMarkBtn();
  renderPalette();
  updateStats();
}

function renderQuestionArea() {
  const idx = state.currentQ;
  const q = state.quizFlat[idx];
  const section = quizSections[q._sectionIndex];
  const localNum = q._localIndex + 1;
  const totalInSection = section.questions.length;
  const markC = section.markCorrect;
  const markW = section.markWrong;

  let optionsHTML = '';
  if (q.type === 'mcq') {
    const labels = ['A','B','C','D','E','F'];
    optionsHTML = `<ul class="options-list">
      ${q.options.map((opt, oi) => `
        <li class="option-item ${state.responses[idx] === oi ? 'selected' : ''}" onclick="selectMCQ(${oi})">
          <span class="option-label">${labels[oi]}</span>
          <span class="option-text">${escHtml(opt)}</span>
        </li>`).join('')}
    </ul>`;
  } else {
    const val = state.responses[idx] !== null ? state.responses[idx] : '';
    optionsHTML = `<div class="integer-input-wrap">
      <label style="font-size:0.82rem;color:var(--muted);display:block;margin-bottom:0.5rem;">Enter Integer Answer:</label>
      <input type="number" class="integer-input" id="int-input" value="${val}" oninput="updateInteger()" placeholder="0">
    </div>`;
  }

  document.getElementById('question-area').innerHTML = `
    <div class="question-number">Q${localNum} of ${totalInSection} &nbsp;¬∑&nbsp; ${q._sectionName}</div>
    <div class="question-meta">
      <span class="q-tag positive">+${markC} Correct</span>
      <span class="q-tag negative">${markW} Wrong</span>
      <span class="q-tag">${q.type === 'mcq' ? 'Single Correct MCQ' : 'Integer Type'}</span>
    </div>
    <div class="question-text">${escHtml(q.text)}</div>
    ${optionsHTML}
  `;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function selectMCQ(oi) {
  const idx = state.currentQ;
  state.responses[idx] = oi;
  if (state.status[idx] === 'marked') state.status[idx] = 'marked_answered';
  else state.status[idx] = 'answered';
  renderQuestionArea();
  renderPalette();
  updateStats();
}

function updateInteger() {
  const idx = state.currentQ;
  const val = document.getElementById('int-input').value;
  state.responses[idx] = val === '' ? null : parseInt(val);
  if (state.status[idx] === 'marked') state.status[idx] = state.responses[idx] !== null ? 'marked_answered' : 'marked';
  else state.status[idx] = state.responses[idx] !== null ? 'answered' : 'not_answered';
  renderPalette();
  updateStats();
}

function clearResponse() {
  const idx = state.currentQ;
  state.responses[idx] = null;
  if (state.status[idx] === 'marked_answered') state.status[idx] = 'marked';
  else if (state.status[idx] !== 'not_visited') state.status[idx] = 'not_answered';
  renderQuestionArea();
  renderPalette();
  updateStats();
}

function toggleMark() {
  const idx = state.currentQ;
  const st = state.status[idx];
  if (st === 'marked') { state.status[idx] = 'not_answered'; }
  else if (st === 'marked_answered') { state.status[idx] = 'answered'; }
  else if (st === 'answered') { state.status[idx] = 'marked_answered'; }
  else { state.status[idx] = 'marked'; }
  updateMarkBtn();
  renderPalette();
  updateStats();
}

function updateMarkBtn() {
  const idx = state.currentQ;
  const st = state.status[idx];
  const btn = document.getElementById('mark-btn');
  if (st === 'marked' || st === 'marked_answered') {
    btn.classList.add('active-mark');
    btn.textContent = 'üîñ Unmark';
  } else {
    btn.classList.remove('active-mark');
    btn.textContent = 'üîñ Mark for Review';
  }
}

function prevQuestion() {
  if (state.currentQ > 0) goToQuestion(state.currentQ - 1);
}
function nextQuestion() {
  if (state.currentQ < state.quizFlat.length - 1) goToQuestion(state.currentQ + 1);
}

// ===================================================
// PALETTE
// ===================================================
function renderPalette() {
  const grid = document.getElementById('palette-grid');
  // Render per current section
  const si = state.currentSection;
  const sectionQs = state.quizFlat.map((q,i) => ({q, i})).filter(({q}) => q._sectionIndex === si);

  grid.innerHTML = sectionQs.map(({q, i}) => {
    let cls = state.status[i];
    let isCurrent = i === state.currentQ ? 'current' : '';
    return `<button class="palette-btn ${cls} ${isCurrent}" onclick="goToQuestion(${i})">${q._localIndex + 1}</button>`;
  }).join('');
}

function updateStats() {
  const status = state.status;
  document.getElementById('stat-answered').textContent = status.filter(s=>s==='answered'||s==='marked_answered').length;
  document.getElementById('stat-not-answered').textContent = status.filter(s=>s==='not_answered').length;
  document.getElementById('stat-marked').textContent = status.filter(s=>s==='marked'||s==='marked_answered').length;
  document.getElementById('stat-not-visited').textContent = status.filter(s=>s==='not_visited').length;
}

// ===================================================
// TIMER
// ===================================================
function startTimer() {
  clearInterval(state.timerInterval);
  state.timerInterval = setInterval(() => {
    state.timeLeft--;
    updateTimerDisplay();
    if (state.timeLeft <= 0) { clearInterval(state.timerInterval); submitQuiz(); }
  }, 1000);
}

function updateTimerDisplay() {
  const t = state.timeLeft;
  const h = Math.floor(t / 3600);
  const m = Math.floor((t % 3600) / 60);
  const s = t % 60;
  const el = document.getElementById('timer');
  el.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
  el.className = 'quiz-timer' + (t < 300 ? ' danger' : t < 600 ? ' warning' : '');
}

function pad(n) { return String(n).padStart(2,'0'); }

// ===================================================
// ANTI-CHEAT
// ===================================================
function attachAntiCheat() {
  document.addEventListener('visibilitychange', onVisibilityChange);
  window.addEventListener('blur', onWindowBlur);
}

function detachAntiCheat() {
  document.removeEventListener('visibilitychange', onVisibilityChange);
  window.removeEventListener('blur', onWindowBlur);
}

function onVisibilityChange() {
  if (!state.running) return;
  if (document.hidden) triggerViolation('tab switch or minimized window');
}

function onWindowBlur() {
  if (!state.running) return;
  if (document.hidden) return; // already caught
  triggerViolation('window lost focus');
}

function triggerViolation(reason) {
  state.violations++;
  const overlay = document.getElementById('cheat-overlay');
  const remaining = state.maxViolations - state.violations;
  document.getElementById('cheat-msg').textContent = `Violation detected: ${reason}. This is being recorded.`;
  if (remaining > 0) {
    document.getElementById('cheat-count').textContent = `Warning ${state.violations}/${state.maxViolations}. ${remaining} more will auto-submit.`;
  } else {
    document.getElementById('cheat-count').textContent = `Maximum violations reached. Submitting...`;
    setTimeout(() => { overlay.classList.remove('show'); submitQuiz(); }, 2500);
    return;
  }
  overlay.classList.add('show');
}

function dismissCheatWarning() {
  document.getElementById('cheat-overlay').classList.remove('show');
}

// ===================================================
// SUBMIT
// ===================================================
function confirmSubmit() {
  const answered = state.status.filter(s=>s==='answered'||s==='marked_answered').length;
  const total = state.quizFlat.length;
  if (confirm(`You have answered ${answered}/${total} questions. Submit the test?`)) submitQuiz();
}

function submitQuiz() {
  state.running = false;
  clearInterval(state.timerInterval);
  detachAntiCheat();
  showResult();
}

// ===================================================
// RESULT
// ===================================================
function showResult() {
  showScreen('result');

  let totalScore = 0, correct = 0, wrong = 0, skipped = 0;
  const maxPossible = state.quizFlat.reduce((acc, q) => acc + quizSections[q._sectionIndex].markCorrect, 0);

  const tbody = document.getElementById('review-body');
  tbody.innerHTML = '';

  state.quizFlat.forEach((q, i) => {
    const section = quizSections[q._sectionIndex];
    const res = state.responses[i];
    let isCorrect = false, score = 0;

    if (res === null) {
      skipped++;
      score = 0;
    } else if (q.type === 'mcq') {
      isCorrect = (res === q.correct);
      score = isCorrect ? section.markCorrect : section.markWrong;
      isCorrect ? correct++ : wrong++;
    } else {
      isCorrect = (parseInt(res) === parseInt(q.correct));
      score = isCorrect ? section.markCorrect : section.markWrong;
      isCorrect ? correct++ : wrong++;
    }

    totalScore += score;

    const labels = ['A','B','C','D','E'];
    const yourAns = res === null ? '‚Äî' : q.type === 'mcq' ? labels[res] : res;
    const correctAns = q.type === 'mcq' ? labels[q.correct] : q.correct;

    const row = document.createElement('tr');
    row.className = res === null ? '' : (isCorrect ? 'r-correct' : 'r-wrong');
    row.innerHTML = `
      <td style="font-family:'IBM Plex Mono',monospace;color:var(--muted)">${q._localIndex+1}</td>
      <td style="font-size:0.78rem;color:var(--muted)">${q._sectionName}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escHtml(q.text.substring(0,60))}${q.text.length>60?'‚Ä¶':''}</td>
      <td style="font-family:'IBM Plex Mono',monospace">${yourAns}</td>
      <td style="font-family:'IBM Plex Mono',monospace;color:var(--accent2)">${correctAns}</td>
      <td style="font-family:'IBM Plex Mono',monospace;color:${score>0?'var(--accent2)':score<0?'var(--danger)':'var(--muted)'}">${score>0?'+':''}${score}</td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById('res-score').textContent = totalScore.toFixed(1);
  document.getElementById('res-out-of').textContent = `out of ${maxPossible}`;
  document.getElementById('result-grid').innerHTML = `
    <div class="result-card"><div class="result-card-val color-correct">${correct}</div><div class="result-card-label">Correct</div></div>
    <div class="result-card"><div class="result-card-val color-wrong">${wrong}</div><div class="result-card-label">Wrong</div></div>
    <div class="result-card"><div class="result-card-val color-skip">${skipped}</div><div class="result-card-label">Skipped</div></div>
    <div class="result-card"><div class="result-card-val" style="color:var(--accent2)">${correct>0?(correct/(correct+wrong)*100).toFixed(1):0}%</div><div class="result-card-label">Accuracy</div></div>
    <div class="result-card"><div class="result-card-val" style="color:var(--warning)">${state.violations}</div><div class="result-card-label">Violations</div></div>
    <div class="result-card"><div class="result-card-val" style="color:var(--muted);font-size:1rem;">${formatElapsed(state.violations)}</div><div class="result-card-label">Tab Switches</div></div>
  `;
}

function formatElapsed(v) { return v + ' switch' + (v!==1?'es':''); }

function showHome() {
  showScreen('home');
}

// Init template
document.getElementById('template-pre').textContent = JSON.stringify(TEMPLATE, null, 2);
</script>
</body>
</html>
